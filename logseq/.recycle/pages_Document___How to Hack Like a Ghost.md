title:: Document/How to Hack Like a Ghost
author:: [[@Sparc Flow]]
abbreviated-title:: How to Hack Like a Ghost 
cover:: ![Image](https://m.media-amazon.com/images/I/814wrSxBBwL._SY160.jpg)
full-title:: How to Hack Like a Ghost
start:: [[Oct 24th, 2023]]
end:: Unfinished
status:: Reading
document_type::

- Highlights
	- ```md
	- you have a new C2 backend running with the exact same configuration. Achieving this level of automation is not a whimsical way to try out the trendiest tools and programming techniques. The easier it is to spring ([Location 699](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=699))
	- ```
	- ```md
	- community, read Permanent Record, by Edward Snowden (Macmillan, 2019). Search for darkAudax’s tutorial ([Location 706](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=706))
	- ```
	- ```md
	- use a classic find command to hunt for source code files containing these strings and pipe them into xargs, which will call sed to replace these suspicious terms with ([Location 772](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=772))
	- ```
	- ```md
	- compile an agent in the output folder that we will later drop on a Windows test machine: root@Lab:~/# make agent-windows ([Location 781](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=781))
	- ```
	- ```md
	- (a Microsoft utility to register DLLs in the Windows Registry so they can be called by other programs; it can be used to trick DLLs like srcobj.dll into executing commands), mshta (a Microsoft utility that executes HTML Applications, ([Location 804](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=804))
	- ```
	- ```md
	- with the command use implant/, from dumping passwords with Mimikatz to pivoting to other machines. If you’re familiar with Empire, then you will feel right at home with Koadic. ([Location 835](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=835))
	- ```
	- ```md
	- perfectly safe-looking evil bombshells. The tool’s serverside requires Python 3.7, so make sure to have Python properly working ([Location 857](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=857))
	- ```
	- ```md
	- payloads, and so on, which is very useful in team operations. You need to leave the server running in the first terminal and then open a second to connect to ([Location 865](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=865))
	- ```
	- ```md
	- [1] ST (stagers) >> generate customListener [+] Generated stager to ./stager.xml If we take a closer look at the stager.xml file, we can see it embeds a base64-encoded version of an executable called naga.exe (SILENTTRINITY/core/teamserver/data/naga.exe), which connects back to the listener we set up and then downloads a ZIP file containing Boo-Lang DLLs and a script to bootstrap the environment. Once we compile and run this payload on the fly using MSBuild, we will have a full Boo environment running on the target’s machine, ready to execute whatever shady payload we send its way: # Start agent PS C:\> C:\Windows\Microsoft.Net\Framework\v4.0.30319\MSBuild.exe stager.xml [*] [TS-vrFt3] Sending stage (569057 bytes) ->  192.168.1.30... [*] [TS-vrFt3] New session 36e7f9e3-13e4-4fa1-9266-89d95612eebc connected! (192.168.1.30) [1] ST (listeners)(https) >> sessions [1] ST (sessions) >> list Name           >> User         >> Address     >> Last Checkin 36e7f9e3-13... >> *wk_adm@PIANO>> 192.168.1.3 >> h 00 m 00 s 04 Notice how, unlike with the other two frameworks, we did not bother customizing the payload to evade Windows Defender. It just works . . . for now! We can deliver any of the current 69 post-exploitation modules, from loading an arbitrary assembly (.NET executable) in memory to regular Active Directory reconnaissance and credential dumping: [1] ST (sessions) >> modules [1] ST (modules) >> use boo/mimikatz [1] ST (modules)(boo/mimikatz) >> run all [*] [TS-7fhpY] 36e7f9e3-13e4-4fa1-9266-89d95612eebc returned job result (id: zpqY2hqD1l) [+] Running in high integrity process--snip-- msv : [00000003] Primary * Username : wkadmin    * Domain   : PIANO.LOCAL * NTLM     : adefd76971f37458b6c3b061f30e3c42--snip-- The project is still very young, yet it displays tremendous potential. If you are a complete beginner, though, you may suffer from the lack of documentation and explicit error handling. The tool is still in ([Location 875](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=875))
	- ```
	- ```md
	- the tooling necessary to faithfully reproduce and automate almost every painful aspect of the manual setup. We’ll stick with ([Location 910](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=910))
	- ```
	- ```md
	- index index.html; server_name www.mydomain.com; # return 404 if no file or directory match location / { try_files $uri $uri/ =404; } # /msf URL gets redirected to our backend C2 framework location /msf { proxy_pass https://192.168.1.29:8443; proxy_ssl_verify off; proxy_set_header Host $host; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; ([Location 925](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=925))
	- ```
	- ```md
	- The solution is to package all your applications with all their dependencies properly installed and tuned to the right version. When you spin up a new machine, ([Location 948](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=948))
	- ```
	- ```md
	- one. It proceeds with its own boot sequence and loads the filesystem, scheduler, kernel structures, the whole nine yards. The guest system believes it is running on ([Location 967](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=967))
	- ```
	- ```md
	- understand how much blood and sweat were spared by these two commands. Of course, you may wonder, “How, in this new isolated environment, can we reach a listener from ([Location 1023](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1023))
	- ```
	- ```md
	- the machine shows the default docker0 bridge with the allocated 172.17.0.0/16 IP range ready to be distributed across new containers: ([Location 1031](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1031))
	- ```
	- ```md
	- 8500 on the host will map to ports 8400 to 8500 in the container: ([Location 1039](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1039))
	- ```
	- ```md
	- reach a handler listening on any port between 8400 and 8500 inside the container by sending packets to the host’s IP address on that same port range. ([Location 1042](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1042))
	- ```
	- ```md
	- run. Next, we use a single instruction to pull the base ([Location 1075](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1075))
	- ```
	- ```md
	- new directory called the image layer. Higher directories shadow lower ones. For instance, a file altered in step 3 during the build process will shadow the same file created ([Location 1083](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1083))
	- ```
	- ```md
	- 3adf0cfdaf374f9c049d40a0eb3401629da05abc48c # Connect to the team server running on the container root@Lab:~st/# ([Location 1101](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1101))
	- ```
	- ```md
	- customdomain>.com should obviously already point to the server’s public IP for this maneuver to work. While Metasploit and SILENTTRINITY containers can run on the same host, the Nginx container should ([Location 1161](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1161))
	- ```
	- ```md
	- Microsoft Azure, Alibaba, and Google Cloud Platform fully embrace automation through a plethora of powerful APIs, but other cloud providers do not seem to care even one iota. Thankfully, this may not be such a big deal for us since we’re managing just three or four servers at any given time. We can easily set ([Location 1186](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1186))
	- ```
	- ```md
	- primordial structures in Terraform is a resource—an element describing a discrete unit of a cloud provider’s service, such as a server, an SSH key, a firewall rule, and so on. The level of granularity depends on the ([Location 1236](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1236))
	- ```
	- ```md
	- format main.tf followed by the plan instruction to build a list of changes about to happen to the infrastructure, as shown next. You can see our server scheduled ([Location 1255](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1255))
	- ```
	- ```md
	- default virtual network segment created by AWS (akin to a router’s interface, if you will). The firewall rules allow incoming SSH ([Location 1303](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1303))
	- ```
	- ```md
	- produced by other Terraform resources. In this example we hardcode the C2’s IP and domain name, but in real life these will be the ([Location 1332](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1332))
	- ```
	- ```md
	- requested resources: root@Bounce:~/infra# terraform fmt && terraform apply aws_key_pair.ssh_key: Creation complete after 0s [id=mykey2] aws_default_vpc.default: Modifications ([Location 1341](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1341))
	- ```
	- ```md
	- like defining variables in a separate file, creating multiple security groups, passing private IPs as variables in user data scripts, and so on. I trust that by now you have enough working knowledge to pull the final refactored version from the ([Location 1356](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1356))
	- ```
	- ```md
	- a datacenter somewhere in Europe. Our attacking infrastructure is eagerly awaiting our first order. Before we unleash ([Location 1382](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1382))
	- ```
	- ```md
	- Drawing tangible goals may very well be our first challenge. Their main website (www.gretschpolitico.com) does not exactly help: it ([Location 1385](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1385))
	- ```
	- ```md
	- “public access,” giving us a plethora of information to begin our quest for understanding ([Location 1391](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1391))
	- ```
	- ```md
	- Google Drive, DocumentCloud, you name it. The following search terms will narrow down your results in most search engines: ([Location 1397](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1397))
	- ```
	- ```md
	- in others, like Yandex, Baidu, Bing, and so on, since Google tends to observe copyright infringement laws and moderates its search output. Another great source of information ([Location 1403](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1403))
	- ```
	- ```md
	- interesting documents pop out, from campaign fund reports mentioning GP to marketing pitches for campaign directors. Manually skimming through this data makes it clear that GP’s core service is building voter ([Location 1412](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1412))
	- ```
	- ```md
	- gathered from telecom companies, credit card issuers, online stores, local businesses, and many more sources. Research studies and surveys It seems that GP reaches out to the population somehow ([Location 1419](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1419))
	- ```
	- ```md
	- the tweet innocuously points to an online advertising agency: MXR Ads. They deliver ads on all kinds of websites, charge per thousand impressions (CPM), and go quietly about their business of increasing ([Location 1428](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1428))
	- ```
	- ```md
	- they even shared the same address a couple of years back. This kind of intertwined connection can be very profitable for both companies. MXR Ads gathers raw data about people’s engagement with a type of product or brand. They know, for example, that the person ([Location 1434](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1434))
	- ```
	- ```md
	- are GP’s clients? Not the pretty ponies they advertise on their slides, like health organizations trying to spread vaccines, but the ugly toads they bury in their databases. And finally, what do these creatives and ads look like? It might ([Location 1448](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1448))
	- ```
	- ```md
	- pretty ambitious, so I hope you are as excited as I am to dive into this strange world of data harvesting and deceit. Scouring GitHub A recurrent leitmotif in almost every presentation of Gretsch ([Location 1456](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1456))
	- ```
	- ```md
	- even a fake dummy test or test account to boost our enthusiasm. Either MXR Ads and GP are good at concealment or we are just not that lucky. No matter, we’ll move on! One feature of GitHub that ([Location 1521](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1521))
	- ```
	- ```md
	- these in a browser. The first link times out, and the second one redirects to a Google authentication page (see Figure 4-5). ([Location 1539](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1539))
	- ```
	- ```md
	- for transparency. It seems that GP did not bother registering subdomain certificates and has instead opted for a wildcard certificate: a generic certificate that matches any subdomain. One certificate to rule them all. Whether this is a brilliant ([Location 1571](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1571))
	- ```
	- ```md
	- adding new resolvers, as some servers ([Location 1621](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1621))
	- ```
	- ```md
	- dozen responded with valid IP addresses: Subdomain              TTL Class   Type   Rdata electron.mxrads.net. ([Location 1624](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1624))
	- ```
	- ```md
	- Over the last decade, we hackers have gotten into the habit of only scanning IP addresses and skipping DNS resolution in order to gain a few seconds, but when dealing with a cloud provider, this could prove fatal. Instead, we should scan domain ([Location 1658](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1658))
	- ```
	- ```md
	- it to finish, we’ll turn our attention to the actual content of the hundreds of domains and websites we found belonging to MXR Ads and Gretsch Politico. Resources ([Location 1665](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1665))
	- ```
	- ```md
	- particular task, the oldest recipe in the world is the most effective one: the more you practice, the better you will get. The more fantastic and incredible the vulnerabilities you encounter, the more confidence you will gain, not only in yourself, but also in the inevitability of human errors. Practice Makes Perfect So how do you get started? ([Location 1678](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1678))
	- ```
	- ```md
	- safe environment. For example, experiment with SQL injections by spinning up a web server and a database in your lab, writing an app, and experimenting with it. Discover the subtleties of different SQL parsers, write your own filters to prevent injections, try to bypass those same filters, and so on. Get into the mind of a developer, face the challenge of parsing unknown input to build a database ([Location 1686](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1686))
	- ```
	- ```md
	- engagement, so time will be the least of our concerns. It is in fact our most precious ally. We will spend as much time as we deem necessary on each website. Your flair and curiosity are all the permissions you need to spend the whole day ([Location 1699](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1699))
	- ```
	- ```md
	- customer, such as servers, load balancers, storage, managed databases, and content distribution endpoints. Take Akamai, a global content delivery network (CDN), for example. For a regular server, Akamai will create a domain name like e9657.b.akamaiedge.net to optimize packet transfer to that server. But no company will seriously ([Location 1704](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1704))
	- ```
	- ```md
	- created as ALIAS records that do not explicitly show up in the name resolution process. For these stubborn cases, we can guess the AWS service by looking up the IP address in the public range published in the AWS documentation ([Location 1727](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1727))
	- ```
	- ```md
	- result is printed in a colorful graph that highlights the underlying interactions between domains, as well as the main cloud services used by a company. Figure 5-1 ([Location 1732](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1732))
	- ```
	- ```md
	- storage service; and ELB, a load balancer. The rest use the Akamai distribution network. Notice how the dashboard URL of GP (top center) points to a domain belonging to MXR Ads (bottom left). We were right about their close relationship; it’s even reflected in their respective infrastructures. We have a few leads here. For example, the ([Location 1739](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1739))
	- ```
	- ```md
	- Firewall (AWS WAF). Whether that is indeed the case is open for speculation and will require active probing, of course. NOTE It’s not like AWS WAF is the glorious WAF that everyone has been waiting for. Every now and then, a tweet pops out with a simple bypass: http://bit.ly/303dPm0. The application load balancer can wait, however. ([Location 1746](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1746))
	- ```
	- ```md
	- companies alike shared the same scandalous journal headlines. Open and vulnerable S3 buckets cost these companies terabytes of sensitive data, like customer information, transaction histories, and ([Location 1762](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1762))
	- ```
	- ```md
	- inspecting the CNAME doesn’t work, we need more elaborate tricks, such as injecting special characters like %C0 in the URL, or appending invalid parameters, in an attempt to get S3 to display ([Location 1818](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1818))
	- ```
	- ```md
	- hoping to land on some form of valid credentials. An interesting fact to keep in mind is that AWS does not log S3 object operations like get-object and put-object by default, so we can download files to our heart’s content with the knowledge that no one has tracked our movements. Sadly, that much cannot be said ([Location 1849](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1849))
	- ```
	- ```md
	- hiding in the pile. To find these files, we run an aggressive inverted search that weeds out common and useless files like images, Cascading Style Sheets (CSS), and fonts in an effort to reveal some hidden gems: root@Point1:~/# ([Location 1855](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1855))
	- ```
	- ```md
	- and, sure enough, the perfect suspect jumps out screaming from the lot: demo.mxrads.com. We saw the same “demo” keyword in the S3 keys with HTML files. We didn’t even have to grep. We enter demo.mxrads.com in the browser and see that the main image and headline seem to describe the behavior we ([Location 1869](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1869))
	- ```
	- ```md
	- take a closer look at this page, we’ll fire up Burp Suite, a local web proxy that conveniently intercepts and relays every HTTP request coming from our browser (OWASP fans can use ZAP, the Zed Attack Proxy). We reload demo.mxrads.com with ([Location 1875](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1875))
	- ```
	- ```md
	- website offers to showcase demo ads on multiple browsers and devices, and also on some featured websites like nytimes.com and theregister.com (see Figure 5-5). Sales teams around the world likely leverage these features to convince media partners that their technology seamlessly integrates with any web framework. Pretty ([Location 1889](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1889))
	- ```
	- ```md
	- app fetches its actual content and adds a video player with a random ad to show potential clients what MXR Ads can do. What vulnerabilities could it possibly introduce? So many . . . Before we look at how ([Location 1897](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1897))
	- ```
	- ```md
	- don’t get much HTTP traffic, that’s for sure. Once the web page is loaded, the server responds with an “HTTP/1.1 101 Switching Protocols” message, then no more communication appears in the HTTP History tab. We need to switch to the WebSockets History tab to follow the rest of the exchange. ([Location 1904](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1904))
	- ```
	- ```md
	- establish a full-duplex and binding tunnel where each one can initiate communications at will. It is not uncommon to have several incoming messages for one outgoing message, or vice versa. (For ([Location 1911](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1911))
	- ```
	- ```md
	- (nytimes.com) followed by metrics related to the user’s browser (Mozilla/5.0. . .), along with an identifier of the ad to display (437). Burp cannot replay (repeat in Burp ([Location 1921](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1921))
	- ```
	- ```md
	- instance, let’s see if we can get the MRX Ads site to fetch the home page of that Nginx container we set up in Chapter 3. Figure 5-8: Intercepting a web page in Burp We forward the modified request and head to our Docker container to explore the logs. We grab the container ID using docker ps ([Location 1925](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1925))
	- ```
	- ```md
	- awesome, you ask? Well, not all domains and IP addresses were created equal, you see. Some IP addresses have particular purposes. A perfect example is the 127.0.0.0/8 block that refers to the loopback address (the host itself), or 192.168.0.0/16, which is reserved for private networks. One lesser-known IP address range is 169.254.0.0/16, which is reserved by the Internet Engineering Task Force (IETF) for link-local addressing, meaning this range is only valid for communication inside a network and cannot ([Location 1935](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1935))
	- ```
	- ```md
	- machine’s hostname, internal IP, firewall rules, and so forth. This is a trove of metadata that could give us a sneak peek into the company’s internal architecture. Let’s give it a go, shall we? With Burp intercept mode still on, we trigger another ([Location 1942](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1942))
	- ```
	- ```md
	- nothing comes back. MXR Ads is not making things easy for us. It’s reasonable to assume that the URL is explicitly banned in the app for precisely this reason. Or maybe the app simply expects a valid domain? Let’s replace the metadata IP with a more innocuous IP (for instance, that of our Nginx container): # Modified WebSocket ([Location 1948](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1948))
	- ```
	- ```md
	- allowed, but 169.254.169.254 must be explicitly banned by the app. Time to whip out our bag of dirty string-parsing tricks. Though IP addresses are commonly expressed in decimal format, browsers and web clients are in fact happy with more esoteric representations, like hexadecimal or octal. For instance, ([Location 1955](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1955))
	- ```
	- ```md
	- http://0xa9fea9fe/latest/meta-data/ami-id2 ami-02df9ea15c1778c9c # Public hostname http://0xa9fea9fe/latest/meta-data/public-hostname3 ec2-3-248-221-147.eu-west-1.compute.amazonaws.com Listing 5-1: Basic information on the web app, pulled ([Location 1989](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1989))
	- ```
	- ```md
	- image ID ami-02df9ea15c1778c9c 2 refers to the snapshot used to run the machine, such as an Ubuntu or CoreOS image. Machine images can be public (available to all AWS customers) or private (available only to specific accounts). This particular ([Location 1998](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=1998))
	- ```
	- ```md
	- metadata API, as shown in Listing 5-2. Understanding what firewall rules exist can give you hints about other hosts that interact with this system and what services may be running on it, even if they aren’t publicly accessible. Firewall rules are managed in objects called security ([Location 2005](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2005))
	- ```
	- ```md
	- can only list the security groups’ names and not the actual firewall rules, but that already carries enough information to guess the actual firewall rules. The elb section in the elb_http_prod_eu-west-1 set, for example, indicates that this ([Location 2019](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2019))
	- ```
	- ```md
	- are far from done, of course, so let’s kick it up a notch. As we saw in Chapter 3, AWS offers the possibility to execute a script when the machine boots for the first time. This script is usually referred to as user-data. We used it to set up our own infrastructure and bootstrap Docker containers. Great news—that ([Location 2027](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2027))
	- ```
	- ```md
	- executed at the machine’s boot time 1. This service pulls the demo-client application image 2 and proceeds to run the container using a well-furnished docker run command 3. Notice the ([Location 2053](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2053))
	- ```
	- ```md
	- embedded directly in the same user-data script. Indeed, if we scroll a bit further we come across the following snippet: --snip-- ([Location 2061](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2061))
	- ```
	- ```md
	- but then AWS went ahead and shot the sheriff with the following statement: “The existing instance metadata service (IMDSv1) is fully secure, and AWS will continue to support it.” Ah, of course companies will invest in rewriting ([Location 2113](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2113))
	- ```
	- ```md
	- case for an instance profile attached to a machine. When we try to get basic information about the role demo-role-ec2, ([Location 2168](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2168))
	- ```
	- ```md
	- reports all sorts of unusual behaviors, such as spamming 5,000 API calls, so caution is paramount. This is not your average bank with 20 security appliances and a $200K/year outsourced SOC team that still struggles to aggregate ([Location 2183](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2183))
	- ```
	- ```md
	- ListBuckets operation: Access Denied Okay, trying to list all S3 buckets in the account was a little too bold, but it was worth a shot. Let’s take it back and take baby steps now. ([Location 2189](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2189))
	- ```
	- ```md
	- getting somewhere! We get a list of keys and save them away. As a precaution, before we go berserk and download every file stored in this bucket, we can make sure that logging is indeed disabled on S3 object ([Location 2197](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2197))
	- ```
	- ```md
	- bucket. AWS has done a spectacular job defining very fine-grained permissions for each tiny and sometimes inconsequential task. No wonder most admins simply assign wildcard permissions when setting up buckets. A user needs read-only access to a bucket? A Get* will do ([Location 2204](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2204))
	- ```
	- ```md
	- a specific source IP. Here we attempt to get the bucket policy for mxrads-dl to see if it does grant access to any other AWS accounts: root@Point1:~/# aws s3api get-bucket-policy ([Location 2211](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2211))
	- ```
	- ```md
	- examination. Examining the Key List We go back to downloading the bucket’s entire key list and dive into the heap, hoping to find sensitive data and get an idea of the bucket’s purpose. We have an impressive number of public binaries and .jar files. ([Location 2219](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2219))
	- ```
	- ```md
	- its infrastructure. We only need a tiny spark to ignite for the whole ranch to catch fire. We still have close to a hundred domains ([Location 2233](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2233))
	- ```
	- ```md
	- pielco11/fav-up/. You can read more about techniques to uncover bucket names at the ([Location 2240](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2240))
	- ```
	- ```md
	- available at http://bit.ly/35FsTHN. Check out this blog about IMDSv2: https://go.aws/35EzJgE ([Location 2247](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2247))
	- ```
	- ```md
	- comfort means we are on the threshold of new insights. Lawrence ([Location 2252](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2252))
	- ```
	- ```md
	- From our work so far, we have a few MXR Ads credentials, and we’ve uncovered the main ways that MXR Ads and GP handle their infrastructure, ([Location 2257](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2257))
	- ```
	- ```md
	- eventually led us to a server-side request forgery (SSRF) vulnerability. But now we’ll abide by a steadier and more strenuous approach. We will go through each website, follow each link, inspect every parameter, and even gather hidden links in JavaScript files using something like LinkFinder ([Location 2260](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2260))
	- ```
	- ```md
	- the programming language, the operating system, and a few other factors, so to help streamline the process we will inject the following payload and compare the output to the application’s normal response: dddd",'|&$;:`({{@<%=ddd This string covers the most obvious occurrences of injection vulnerabilities for different frameworks: ([Location 2267](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2267))
	- ```
	- ```md
	- investigating further. If the web page returns an innocuous response but seems to have transformed or filtered the input somehow, then we can probe further using more advanced payloads, like adding logical operators (AND 1=0), pointing to a real file location, trying a real command, and so on. We begin injecting this payload into the forms on each site in our list. Soon enough, we reach the URL www.surveysandstats.com, ([Location 2274](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2274))
	- ```
	- ```md
	- Figure 6-1: Surveysandstats.com reacts to our string injection Aha! That’s the kind of error that can make a hacker squirm with excitement. We turn to Burp and submit the form again, this time with perfectly innocent responses to the survey question with no special characters, just plain English, to make sure that the form normally works ([Location 2280](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2280))
	- ```
	- ```md
	- execute arbitrary code, others will not even let you perform simple multiplication. That’s why our first order of business is to gather more information about this potential vulnerability. We need to figure out what language we are dealing with and ([Location 2311](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2311))
	- ```
	- ```md
	- enter a few different expressions in our survey form to see how they’re executed. ([Location 2317](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2317))
	- ```
	- ```md
	- Payload {{8*'2'}} # Python: 22222222, PHP: 16 {{8*2}} # Python: 16, PHP: 16 Figure 6-5: Typical Python output for an input of 8 * '2' From this ([Location 2325](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2325))
	- ```
	- ```md
	- payload that works on both Flask and Django Jinja2 templates, and it’s a good one: request.environ. In both frameworks, this Python object holds information about the current request: HTTP method, headers, user data, and, most importantly, environment variables loaded by the app. # Payload email=davidshaw@pokemail.net& ([Location 2332](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2332))
	- ```
	- ```md
	- templating engine with the more powerful Jinja2 templating framework. This is lucky for us, because while Jinja2 supports a subset of Python expressions and operations that give it the edge in terms of performance and productivity, this flexibility comes at a steep price: we can ([Location 2341](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2341))
	- ```
	- ```md
	- template, so we can naturally retrieve it. The os module? Highly unlikely. But, and it is a most fortunate but, most modern programming languages provide us with some degree of introspection and reflection—reflection being the ability of a program, object, or class to examine itself, including listing its own properties and methods, changing its ([Location 2348](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2348))
	- ```
	- ```md
	- email=davidshaw@pokemail.net&user={{request__class__ }}... <class 'django.core.handlers.wsgi.WSGIRequest'> That class is itself a child class of a higher Python object called django.http.request.HttpRequest. We did not even have to read the docs to find this out; it’s written in the object itself, inside the __base__ ([Location 2355](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2355))
	- ```
	- ```md
	- object. In and of itself, the object class is useless, but like all other classes, it contains references to its subclasses as well. So after climbing up the chain, it’s now time to go down using the __subclasses__ method: # Payload email=davidshaw@pokemail.net&user={{request.__class__.__base__.__base__.__subclasses__()}}... ([Location 2364](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2364))
	- ```
	- ```md
	- the object class and loaded by the current Python interpreter. NOTE In Python 3, all top classes are children of the object class. In Python 2, classes must explicitly inherit the object class. I hope you caught the subprocess.Popen class 1! This ([Location 2371](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2371))
	- ```
	- ```md
	- couple of seconds later, we receive an email spilling out the environment variables of the Python process running on the machine: PWD=/opt/django/surveysapp PYTHON_GET_PIP_SHA256=8d412752ae26b46a39a201ec618ef9ef7656c5b2d8529cdcbe60cd70dc94f40c KUBERNETES_SERVICE_PORT_HTTPS=443 HOME=/root--snip-- ([Location 2380](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2380))
	- ```
	- ```md
	- surveysapp, and the settings file is usually one directory below that (with the same name). In Listing 6-1, we try to access it. # Payload email=davidshaw@pokemail.net&user={{request.__class__.__base__.__base__.__subclasses__() ([Location 2386](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2386))
	- ```
	- ```md
	- results to candidates. These credentials will probably have a very narrow scope of action, like sending emails. We can try to be creative and phish some admins using this newly acquired capability, but right now, these credentials will serve a more pressing goal: confirming ([Location 2397](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2397))
	- ```
	- ```md
	- runccd&", shell=True, stdout=-1).communicate()[0]}}...<empty> Some sort of filter seems to block HTTP requests going to the outside world. Fair enough. We’ll try going in the opposite direction and query the metadata API 169.254.169.254. ([Location 2420](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2420))
	- ```
	- ```md
	- S3 bucket to bypass the network ban, but if you recall, we already met an application that was not subject to these restrictions: the demo application from Chapter 5. We could have perfectly leveraged the SSRF vulnerability we found earlier to design a quasi-duplex communication channel using the following ([Location 2565](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2565))
	- ```
	- ```md
	- user “root” in this namespace is mapped to some random unprivileged user ID on the host. A quick way to corroborate our hypothesis is to look more closely at the process bearing the PID number 1: examine its command line attributes, cgroups, and mounted folders. We can explore these different ([Location 2578](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2578))
	- ```
	- ```md
	- belonging to our narrow and very limited namespace. One of the very first reflexes to have when landing in a container is to check whether it is running in privileged mode. Checking for Privileged Mode In privileged execution mode, Docker ([Location 2593](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2593))
	- ```
	- ```md
	- mode, we can just mount the main partition, slip an SSH key in any home folder, and open a new admin shell on the host. Here’s a quick proof of concept of just that in the lab for illustration purposes: # Demo lab root@DemoContainer:/# ([Location 2599](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2599))
	- ```
	- ```md
	- AAAAB3NzaC1yc2EA..." > /mnt/root/.ssh/authorized_keys# get the host's IP and SSH into it root@DemoContainer:/# ssh root@172.17.0.1 root@host:/# NOTE An unprivileged user even inside a privileged container could not easily break out using this technique since the mount command ([Location 2607](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2607))
	- ```
	- ```md
	- documentation and come across the sysctl Docker flag, which essentially runs the sysctl command from within the container. However, when run, this command will, of course, fail to change the kernel TCP timeout option unless it’s invoked in privileged mode. The fact that putting the container in privileged mode is a security risk would not even cross ([Location 2616](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2616))
	- ```
	- ```md
	- folder’s contents, but the result lacks all the classic pseudo-device files like tty*, sda, and mem that imply privileged mode. Some admins trade the privileged mode for a list of individual permissions or capabilities. Think of capabilities as a fine-grained breakdown of the permissions classically attributed to the all-powerful root user on Linux. A user with the capability CAP_NET_ADMIN would be ([Location 2622](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2622))
	- ```
	- ```md
	- powerful capabilities can be leveraged to break namespace isolation and reach other containers or even compromise the host by sniffing packets routed to other containers, loading kernel modules that execute code on the host, or mounting other containers’ filesystems. ([Location 2632](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2632))
	- ```
	- ```md
	- capabilities. In other words, even if the first input of this list is nullified, the parent can still infuse its children with its inheritable or permitted capabilities. If the executable file has capabilities, this third input is ignored. The child’s CapEff list is equal to its CapPrm if the file has the effective ([Location 2657](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2657))
	- ```
	- ```md
	- Maybe you follow the newest and hippest technologies as soon as they hit the market. Maybe you’re too busy busting Windows domains to keep up with the latest trends ([Location 2709](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2709))
	- ```
	- ```md
	- magical new beast called Kubernetes, the ultimate container orchestrator and deployment solution. Kube fanatics will tell you that this technology solves all the greatest challenges of admins and DevOps. That it just works out of the box. Magic, they claim. Sure, give a helpless individual a wing suit, point to a ([Location 2711](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2711))
	- ```
	- ```md
	- grateful. If qualified, overpaid engineers were designing unauthenticated APIs and insecure systems in 2017, who am I to argue? Any help is much appreciated, folks. Having said that, I believe that Kubernetes is a powerful and disruptive technology. It’s probably here to stay and has the potential to play such a critical role in a company’s architecture that I feel compelled to present a crash course on its internal workings. If you’ve already deployed clusters from scratch or written your own controller, ([Location 2718](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2718))
	- ```
	- ```md
	- containers?” If you play a little bit with the containers in the infrastructure we set up in Chapter 3, you will quickly hit some frustrating limits. For instance, to deploy a new version of a container image, you have to alter the user data and ([Location 2726](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2726))
	- ```
	- ```md
	- by providing an environment to run, manage, and schedule containers efficiently across multiple machines. Want to add two more Nginx containers? No problem. That’s literally one command away: root@DemoLab:/# kubectl scale --replicas=3 deployment/nginx Want to update the ([Location 2732](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2732))
	- ```
	- ```md
	- the host’s IP, injecting a private key, SSH, docker exec, and so on. It’s not 2012 anymore! A simple kubectl exec from your laptop will suffice: root@DemoLab:/# kubectl exec sparcflow/nginx-7543 bash root@sparcflow/nginx-7543:/# NOTE ([Location 2739](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2739))
	- ```
	- ```md
	- the aforementioned actions and much more without a whisper of authentication. Nichts, zilch, nada. And that was just one entry point; three others gave similar access. It was brutal. In the last two years or so, however, Kubernetes has implemented many new security features, from role-based access control to network filtering. While some companies are still stuck with clusters older ([Location 2748](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2748))
	- ```
	- ```md
	- Kubernetes cluster. We will play with some rudimentary commands before deconstructing the whole thing, so indulge some partial information in the next few paragraphs. It will all come together in the end. NOTE If you want to follow along, I encourage you to boot up a Kubernetes cluster for free using Minikube (https://minikube.sigs.k8s.io/docs/start/). It’s a tool that runs a single-node ([Location 2755](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2755))
	- ```
	- ```md
	- second container with a small local database to answer queries. That’s where pods enter the scene. A pod is essentially one or many containers considered by Kubernetes as a single unit. All containers within a pod will be scheduled together, spawned together, and terminated together (see Figure 7-1). The most common way you interact with Kubernetes is by submitting manifest files. These files describe the desired state of the ([Location 2763](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2763))
	- ```
	- ```md
	- Figure ([Location 2770](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2770))
	- ```
	- ```md
	- First container image: sparcflow/nginx # Name of the public image ports: - containerPort: 8080 # Listen on the pod's IP address - name: mydb   # Second container image: redis # Name of the public image ports: - containerPort: 6379 Listing 7-1: The manifest file to create a pod comprising two containers We send this ([Location 2777](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2777))
	- ```
	- ```md
	- READY   STATUS         RESTARTS   AGE myapp   2/2     Running        0          1m23s Our pod consisting of two containers is now successfully running on one of the 100 machines in the cluster. Containers in the same pod are treated as a single unit, so Kube ([Location 2787](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2787))
	- ```
	- ```md
	- network and volume namespaces and shares them with the rest of the containers in the pod (refer to https://www.ianlewis.org/ for more on this). ([Location 2796](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2796))
	- ```
	- ```md
	- pod has an IP address and lives on a virtual or bare-metal machine called a node. Each machine in our cluster is a node, so the cluster has 100 nodes. Each node hosts a Linux distribution with some special Kubernetes tools and programs to synchronize with the rest of the cluster. One pod is great, but two ([Location 2801](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2801))
	- ```
	- ```md
	- be running at any given time and oversees the replication strategy. It will automatically respawn pods if they go down, but its key feature is rolling updates. If we decide to update the container’s image, for instance, and thus submit an updated deployment manifest, it will strategically replace pods in ([Location 2809](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2809))
	- ```
	- ```md
	- create the pod as a deployment object, we push a new manifest file of type Deployment, specify the labels of the containers to replicate, and append the previous pod’s configuration in its manifest file (see Listing 7-2). Pods are almost always created as part of deployment resources. # deployment_myapp.yaml file ([Location 2815](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2815))
	- ```
	- ```md
	- name spec: selector: matchLabels: # The label of the pods to manage app: myapp replicas: 2 # Tells deployment to run 2 pods template: # Below is the classic definition of a pod metadata: labels: app: myapp # Label of the pod spec:      containers: - name: nginx   # First container image: sparcflow/nginx ports: - containerPort: 8080 - name: mydb   # Second container image: redis ([Location 2820](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2820))
	- ```
	- ```md
	- somewhere. Now to the fun part. Let’s deconstruct ([Location 2881](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2881))
	- ```
	- ```md
	- multiple rules based on its destination IP and port (-d and --dport flags): ([Location 2896](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2896))
	- ```
	- ```md
	- client.key--snip-- Our API server URL in this case is https://192.168.99.100. Think of it this way: the API server ([Location 2931](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2931))
	- ```
	- ```md
	- such as how many pods there are, their manifest files, service descriptions, node descriptions, and so on. Once the API server writes the deployment object to etcd, the desired state has officially been altered. It notifies the callback handler that subscribed to this particular event: the deployment controller, another ([Location 2938](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2938))
	- ```
	- ```md
	- that a deployment has been initialized, but does not find any reference to the group of pods it is supposed to manage. It resolves this discrepancy by creating a ReplicaSet, an object describing the replication strategy of a group of pods. This operation goes through the API server again, which updates the state once more. This time, however, the event is sent to the ReplicaSet controller, ([Location 2944](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2944))
	- ```
	- ```md
	- sees two pods in the database in a pending state. Unacceptable. It runs its scheduling algorithm to find suitable nodes to host these two pods, updates the pods’ descriptions with the corresponding nodes, and submits the lot to the API server to be stored in the database. The final piece of this bureaucratic ([Location 2951](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2951))
	- ```
	- ```md
	- information about etcd, see http://bit.ly/36MAjKr and http://bit.ly/2sds4bg. Hacking Kubernetes through unauthenticated APIs is covered at http://bit.ly/36NBk4S. ([Location 2967](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2967))
	- ```
	- ```md
	- Armed with this new understanding of Kubernetes, we head back to our improvised remote shell on the survey application to gather information, ([Location 2973](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2973))
	- ```
	- ```md
	- knowledge, these environment variables take on a new meaning: KUBERNETES_PORT_443_TCP must refer to the cluster IP hiding the API server, the famous Kube orchestrator. The documentation states that the API follows the OpenAPI standard, so we can target the default /api route using the infamous curl utility. The -L switch ([Location 2979](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2979))
	- ```
	- ```md
	- out. The response we get is all but surprising. Starting from version 1.8, Kubernetes released a stable version of role-based access control (RBAC), a security model that locks access to the API server to unauthorized ([Location 2987](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2987))
	- ```
	- ```md
	- implementation. Admins can create user accounts for human operators or service accounts that can be assigned to pods. Each ([Location 2993](https://readwise.io/to_kindle?action=open&asin=B08FH9SQNG&location=2993))
	- ```